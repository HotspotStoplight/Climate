import ee
import wxee

ee.Initialize(project='hotspotstoplight')
wxee.Initialize()


def make_exposure_data(bbox, flood_prob):

    print(f"Generating exposure data...")

    pop = ee.Image("JRC/GHSL/P2023A/GHS_POP/2020").clip(bbox)

    pop_xr = pop.wx.to_xarray()

    max_pop_value = pop_xr.max()['population_count'].values.item()

    max_pop_value_ee = ee.Number(max_pop_value)

    pop_min_max_stand = pop.divide(max_pop_value_ee).rename('population_minmax_standardized')

    exp = pop_min_max_stand.multiply(flood_prob).rename('exposure')

    return exp


def make_vulnerability_data(bbox, exp):
    print("Generating vulnerability data...")

    gdp_hdi_30arc = ee.Image("projects/sat-io/open-datasets/GRIDDED_HDI_GDP/HDI_1990_2015_v2").select('b1').clip(bbox).set('system:time_start', 0)

    inverted_hdi_vulnerability = gdp_hdi_30arc.multiply(-1).add(1)

    vuln = exp.multiply(inverted_hdi_vulnerability).rename('vulnerability')

    return vuln
