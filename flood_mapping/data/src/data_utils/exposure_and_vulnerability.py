import ee
from google.cloud import storage

def z_score_normalize(image, bbox):
    mean = image.reduceRegion(reducer=ee.Reducer.mean(), geometry=bbox, scale=30, maxPixels=1e13).getNumber(image.bandNames().get(0))
    std_dev = image.reduceRegion(reducer=ee.Reducer.stdDev(), geometry=bbox, scale=30, maxPixels=1e13).getNumber(image.bandNames().get(0))
    return image.subtract(mean).divide(std_dev)

def make_vulnerability_data(bbox):
    print("Generating vulnerability data...")

    gdp_per_capita = ee.Image("projects/sat-io/open-datasets/GRIDDED_HDI_GDP/GDP_per_capita_PPP_1990_2015_v2").select('b1').clip(bbox)
    hdi_30arc = ee.Image("projects/sat-io/open-datasets/GRIDDED_HDI_GDP/HDI_1990_2015_v2").select('b1').clip(bbox)
    population = ee.Image("JRC/GHSL/P2023A/GHS_POP/2030").clip(bbox)

    # First, multiply GDP by HDI and then Z-score normalize the results
    gdp_hdi_product = gdp_per_capita.multiply(hdi_30arc)
    gdp_hdi_product_normalized = z_score_normalize(gdp_hdi_product, bbox)

    # Second, Z-score normalize population
    population_normalized = z_score_normalize(population, bbox)

    # Then, divide population by the Z-scored product of GDP and HDI
    vuln = population_normalized.divide(gdp_hdi_product_normalized).rename('vuln')

    return vuln
