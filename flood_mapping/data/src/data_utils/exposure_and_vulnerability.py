import ee
import wxee

ee.Initialize(project='hotspotstoplight')
wxee.Initialize()


def make_exposure_data(bbox, flood_prob):

    print(f"Generating exposure data...")

    pop = ee.Image("JRC/GHSL/P2023A/GHS_POP/2030").clip(bbox)

    min_max = pop.reduceRegion(reducer=ee.Reducer.minMax(), geometry=bbox, scale=30, maxPixels=1e13)

    min_val = ee.Number(min_max.get('population_count_min'))
    max_val = ee.Number(min_max.get('population_count_max'))

    pop_scaled = pop.unitScale(min_val, max_val)

    exp = pop_scaled.multiply(flood_prob).rename('exposure')

    return exp

def make_vulnerability_data(bbox, exp):
    print("Generating vulnerability data...")

    gdp_hdi_30arc = ee.Image("projects/sat-io/open-datasets/GRIDDED_HDI_GDP/HDI_1990_2015_v2").select('b1').clip(bbox)

    inverted_hdi_vulnerability = gdp_hdi_30arc.multiply(-1).add(1)

    vuln = exp.multiply(inverted_hdi_vulnerability).rename('vulnerability')

    min_max = vuln.reduceRegion(reducer=ee.Reducer.minMax(), geometry=bbox, scale=30, maxPixels=1e13)

    min_val = ee.Number(min_max.get('vulnerability_min'))
    max_val = ee.Number(min_max.get('vulnerability_max'))

    vuln_scaled = vuln.unitScale(min_val, max_val)

    return vuln_scaled